---
title: "Stress (CORT) response to witnessing attacks on a conspecific"
author: "Blake Jones, Adam Smith, Sara Bebus, Steve Shoech"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    css: custom.css
    theme: united
---

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 250)
```
# Primary questions

1. Is there a stress response (measured by CORT [ng/mL]) after witnessing a predator attack on a conspecific?  
2. Is there a difference between a natural avian predator attack vs. human attack?  

In all cases, the witnessed "attack" represents an extremely acute (2 - 8 sec) stressor, which contrasts markedly with how tests of "acute" stressors have been performed up to this point.

# Experimental design summary
**See manuscript for more details**
18 test starlings (*Sturnus vulgaris*) observed, from a distance of 4 m, a conspecific lure experience one of three stressors (treatments) of interest:    
1. (control) Lure not attacked, but subjects sat in observation cages (with lure movement as in a raptor attack) for a randomly selected time (mean ± SD: 105.0 ± 25.1 min)  
2. (human) Observation of a human "attack" on a conspecific (mean ± SD: 100.7 ± 22.8 min)  
3. (raptor) Observation of a raptor attack (usually falcon) on a conspecific (mean ± SD: 108.0 ± 27.5 min)  

<img src="./Figures/BI_trapping_arena.png">
<br>
**Figure 1**. Experimental setup.  See text for details.

# Statistical analysis summary
We evaluated the effects of attack treatment of CORT response using a linear mixed effects model in R (version 3.0.3; R Core Team 2014) with the nlme package (Pinheiro et al. 2014).  Our experimental design constituted an 18-sequence, 4-period, 3-treatment crossover design. The design provided a strongly-balanced test with respect to first-order carryover effects, allowed us to evaluate  so-called 'self' and 'mixed' carryover effects (Kumert & Stufken 2002), and guaranteed that carryover effects were not aliased with treatment or period effects. We randomly assigned a single individual to each of 18 unique sequences.  A "wash-out" period of at least 24 h between treatments allowed CORT to return to baseline levels and reduced the possibility of carryover effects in CORT measurements. 

In addition to treatment, period, first-order carryover, and carryover type (i.e., 'self' or 'mixed') effects, we allowed for a possible interaction between carryover type and first-order carryover effects.  We also included four covariates in the analysis: active body or flight feather molt (yes/no), witness sex and baseline CORT measured prior to the experiment in the standardized capture and handling stress series, and length of time waiting in observation cage prior to treatment.  Residual variance increased with the expected CORT response, so we modelled this heterogeneity as an exponential function of the fitted CORT values (Pinheiro and Bates 2000).  We included random intercepts for individuals and each of the 26 treatment events required to complete the experiment; however, there was no excess variability attributable to treatment events beyond residual variation, so we excluded this random effect from the model.  Data and code for the analysis are provided at TBD. 

Annotated R code follows:

## Load aliases, functions, and necessary packages
```{r loadstuff, message=FALSE}
# Load some useful aliases and functions
devtools::source_gist(9216051) # Rprofile.R
devtools::source_gist(9216061) # various.R

# Loading required packages
toLoad = c("lsmeans", "multcomp", "gridExtra", "lme4", "pbkrtest", "equivalence", "plyr", 
           "psych", "bbmle", "reshape2", "ggplot2", "gtable", "MuMIn")
instant_pkgs(toLoad)
theme_set(theme_bw(base_size = 16))
```

## Load the data
Treatments (`trt`) are 1 (control), 2 (human), and 3 (raptor); `molt` is no/yes (0/1).  `cort0` and `stress0` refer to the baseline and stress response measured before the experiment.  `id` denotes the individual (n = 18).  `event` records the grouping of individuals observing a given treatment (26 events necessary to complete the experiment).  `attck_time` notes the length of time that individuals sat in observation cages prior to the treatment.  

## Raw data plots
The bottom row shows the relationship between all variables of interest (X-axis in each) and measured CORT (Y-axis).  Note the strong association between treatment and CORT.  There is essentially no multicollinearity. 
```{r loaddata, fig.height=10, fig.width=12, echo=FALSE}
# Load the data
dat <- import.data(read.csv("./Data/bicort.csv", header = TRUE),
                     types = c(rep("factor", 10), rep("integer", 2),
                               rep("numeric", 3)))
# Format sex so we can plot it in the pairs plot
dat$sex_M <- as.numeric(as.factor(dat$sex)) - 1

pairs.panels(dat[, c("cort0", "stress0", "trt", "event", "attck_time", 
                     "period", "priorprd", "self", "molt", "sex_M", "cort")],
             scale=TRUE, ellipses=FALSE)

dat <- within(dat, {
  # Create dummy variables for carryover effect estimation in nlme
  prev_human = factor(ifelse(priorprd == "2", 1, 0))
  prev_raptor = factor(ifelse(priorprd == "3", 1, 0))
  # Create additional dummy variables for carryover type/carryover interaction exploration
  self_human = factor(ifelse(self == 1 & priorprd == 2, 1, 0))
  self_raptor = factor(ifelse(self == 1 & priorprd == 3, 1, 0))
  mixed_control = factor(ifelse(self == 0 & priorprd == 1, 1, 0))
  mixed_human = factor(ifelse(self == 0 & priorprd == 2, 1, 0))
  mixed_raptor = factor(ifelse(self == 0 & priorprd == 3, 1, 0))
})
```

## Initial model fit and diagnostics
We first fit an initial `lmer` model that assumes homogeneous error.  
```{r base_nlme, fig.height=8, fig.width=10}
# This first model allows random intercepts for individuals and treatment events
# Random effect variance for events is essentially zero so simplify model to 
# include only individual random effect variance
modBase <- lmer(cort ~ trt + period + self + prev_human + prev_raptor + self_human + self_raptor + 
                 molt + sex + cort0 + attck_time + (1|id) + (1|event), data = dat)

# Fit simplified base model
modBase <- lmer(cort ~ trt + period + self + prev_human + prev_raptor + self_human + self_raptor + 
                 molt + sex + cort0 + attck_time + (1|id), data = dat) 

# Diagnostics from lmer model
# Population level residuals
grid.arrange(qplot(predict(modBase, re.form = NA), resid(modBase, type="pearson"),
                  xlab = "Fitted (population level)", ylab = "Standardized residual"),
          qplot(as.numeric(dat$trt), resid(modBase, type="pearson"), ylab = "Standardized residual"),
          qplot(predict(modBase, re.form = NA), sqrt(abs(resid(modBase, type = "pearson"))), 
                xlab = "Fitted (population level)", ylab=expression(sqrt(abs(resid)))), 
          ncol = 2)
```

## Heterogeneous error model
The diagnostic plots from the base model indicate clear heteroscedacity in the residuals.  The natural step to accomodate variance heterogeneity in this case is to allow separate variance estimates for each treatment.  This greatly improves the model fit and, as illustrated next, model diagnostics. 
```{r hetero_lmer}
# First, create an observation-level factor variable
# This lets us specify variances separately by treatment
dat <- transform(dat, obs = factor(seq(nrow(dat))))

# Fit the variances separately by treatment
modId <- lmer(cort ~ trt + period + self + prev_human + prev_raptor + self_human + self_raptor + 
                molt + sex + cort0 + attck_time + (1|id) + (0 + dummy(trt, "2")|obs) +
                (0 + dummy(trt, "3")|obs), 
              control=lmerControl(check.nobs.vs.nlev="ignore",
                                check.nobs.vs.nRE="ignore"),
              data = dat)
AICctab(modBase, modId, nobs = nrow(dat), weights=T) # Heterogeneous preferred 
```

Model diagnostics are greatly improved in the heterogeous model.
```{r exp_diagnostics, fig.height=8, fig.width=10}
# Get Pearson residuals
# Requires some manipulation of merMod object because of odd random effect structure 
# specification necessary to fit heterogeneous model
pres <- function(raw_resids, trts, merMod) {
  pres <- rep(0, length(raw_resids))
  for (i in 1:length(raw_resids)) {
    res <- raw_resids[i]
    trt <- trts[i]
    j <- switch(trt, 
                control = 3,
                human = 2,
                raptor = 1)
    
    var <- summary(modId)$varcor[[j]][1] + sigma(merMod)^2
    pres[i] <- res / sqrt(var)
  }
  pres
}

resids_raw <- dat$cort - predict(modId, re.form = NA)
resids_p <- pres(resids_raw, as.character(dat$trt_name), modId)

grid.arrange(qplot(predict(modId, re.form = NA), resids_p,
                  xlab = "Fitted (population level)", ylab = "Standardized residual"),
          qplot(as.numeric(dat$trt), resids_p, ylab = "Standardized residual"),
          qplot(predict(modId, re.form = NA), sqrt(abs(resids_p)), 
                ylab=expression(sqrt(abs(standardized_residual)))), 
          ncol = 2)

```

## Assessment of fixed effects
First, we consider the necessity of the interaction between carryover effect and the type of carryover effect ("self" vs. "mixed").  There's not strong evidence of an interaction: 
```{r test_interaction, echo=FALSE}
KRmodcomp(modId, update(modId, . ~ . - self_human - self_raptor))
```

We drop this lone interaction and thus model only the additive effects of carryover (i.e., does the treatment in the previous period influence CORT response in the current treatment) and whether the previous treatment was the same as ("self" carryover) or different from ("mixed" carryover) the current treatment.  

There is little evidence that birds respond differently when the attack experienced in the preceding exposure was the same as the current exposure ("self" carryover) compared to when the prior attack was different from the current attack:
```{r test_self, echo=FALSE}
modId2 <- update(modId, . ~ . - self_human - self_raptor)
KRmodcomp(modId2, update(modId2, . ~ . - self))
```

nor is there much evidence that the treatment experienced in the prior treatment influences the CORT response of the current treatment.  In other words, there is no indication of first-order carryover effects:
```{r test_CO, echo=FALSE}
KRmodcomp(modId2, update(modId2, . ~ . - prev_human - prev_raptor))
```

Similarly, the CORT response to a treatment did not vary consistently with when in the sequence (i.e., which period) the treatment occurred:
```{r test_prd, echo=FALSE}
# Test for period effects
KRmodcomp(modId2, update(modId2, . ~ . - period))
```

## Nuisance covariates
Before addressing the treatment effects, note than none of the covariates (baseline CORT, molt, sex, attack time) explained much variation in CORT response, although birds that sat in the observation cages for longer periods of time tended to have increased CORT responses.  This should be interpreted with caution, however, as the tests reported here are too "optimistic" in the sense that the F-test probably needs some adjustment to correct the denominator degrees of freedom (e.g., the Kenward-Roger approximation).  The K-R adjustment is not available in R for `lme` models, but the same model in SAS, which does offer the K-R adjustment, suggests that the positive association between time spent in the observation cage and CORT response is marginal (*p* = 0.05).  Nonetheless, this positive association is **opposite** of what might be expected if birds were still returning to baseline when the earliest attacks occurred.  
```{r test_covariates, echo=FALSE}
KRmodcomp(modId2, update(modId2, . ~ . - cort0))
KRmodcomp(modId2, update(modId2, . ~ . - molt))
KRmodcomp(modId2, update(modId2, . ~ . - sex))
KRmodcomp(modId2, update(modId2, . ~ . - attck_time))
```

## Treatment effects
In contrast to other covariates, there  is very clear evidence that the stress response varies among treatments, and that all treatments are different from each other.  The evidence remains very strong after adjusting degrees of freedom:
```{r test_trt, echo=FALSE}
# Test for treatment effects
KRmodcomp(modId2, update(modId2, . ~ . - trt))

# Adjusted (least squares) means
(paired_trt_diffs <- as.data.frame(summary(lsmeans(modId2, pairwise ~ trt)$contrast)))
lsm <- as.data.frame(summary(lsmeans(modId2, ~ trt)))

# Compare with pre-experiment baseline response
baseline <- unique(dat[, c("id", "cort0")])
baseSD <- with(baseline, sd(cort0))
baseline <- with(baseline, mean(cort0))

# Compare with pre-experiment stress response
stress <- unique(dat[, c("id", "stress0")])
stressSD <- with(stress, sd(stress0))
stress <- with(stress, mean(stress0))

# Variance explained
R2 <- r.squaredGLMM(modId2)

# Effect size estimates for raptor - control & raptor - human
cohens_d <- function(comparison) {
  diff <- paired_trt_diffs[comparison, "estimate"]
  sd <- paired_trt_diffs[comparison, "SE"] * sqrt(length(unique(dat$id)))
  d <- diff/sd
  d
}

# Raptor - control
rc_effect <- cohens_d(2) * -1

# Raptor - human
rh_effect <- cohens_d(3) * -1
```

### Effect sizes

The effect sizes (Cohen's D) for the comparison of raptor attack with the control and human attack were `r round(rc_effect, 2)` and `r round(rh_effect, 2)`, respectively.

## Variance explained

The marginal (i.e., variance explained by fixed effects) *R*^2^ values for our final linear mixed model, as defined by Nakagawa and Schielzeth (2013), is `r round(R2[1], 2)`.  We do not report the conditional R^2^ given the slightly contrived random effects structure necessary to fit the heterogeneous variance model in `lme4`.

```{r Figure2, echo=FALSE, fig.width=8, fig.height=5}
indiv_dat <- melt(dat, id.vars=c("id", "trt"), measure.vars=c("cort", "cort0", "stress0"))
indiv_dat <- mutate(indiv_dat,
                    trt = factor(ifelse(variable == "cort0", "cort0",
                                        ifelse(variable == "stress0", "stress0", trt)),
                                 levels = c("cort0", "stress0", "1", "2", "3"),
                                 labels = c("baseline", "stress-\ninduced", "control", "human\nattack", "raptor\nattack")),
                    when = ifelse(Left(trt, 4) == "base", "Pre-experiment", "Experiment"))

indiv_dat <- ddply(indiv_dat, .(id, trt), summarize,
                   cort = mean(value))

# Setting theme for producing figure
windowsFonts(Times=windowsFont("TT Times New Roman"))
theme_set(theme_bw(base_size = 16))
theme_update(panel.grid.minor = element_blank(),
             panel.grid.major= element_blank(),
             panel.border = element_blank(),
             panel.background= element_blank(),
             axis.line = element_line(color = "black"),
             legend.position = "none",
             plot.margin = unit(c(0, 0, 2.5, 0.5), "lines"))

p <- ggplot(indiv_dat, aes(trt, cort)) + geom_boxplot() +
  scale_y_continuous("Corticosterone (ng/mL)", limits=c(0,65), breaks=seq(0, 60, 10)) + 
  scale_x_discrete("") +  
  geom_segment(x=2.5, xend=2.5, y=67.5, yend=-20, linetype="longdash") +
  theme(axis.title.y=element_text(vjust=1))
# Or, use Times font
#  theme(axis.title.y=element_text(vjust=0.3), text=element_text(family="Times"))
p <- ggplotGrob(p)
ff <- "" # Change to "Times" for Times New Roman font
p <- gtable_add_grob(p,
                     grobTree(textGrob("Capture-and-restraint", 
                                       x = 0.2, y = 1.25, vjust = 1,
                                       gp = gpar(fontsize = 14, fontfamily=ff)),
                              textGrob("Experiment", 
                                       x = 0.7, y = 1.25, vjust = 1,
                                       gp = gpar(fontsize = 14, fontfamily=ff))),
                              t=6, l=4)
p$layout$clip <- "off"
grid.draw(p)

# Sans serif version
#png(file="./Output/cort_boxplots.png", width = 5.5, height = 4.5, units = "in", res = 1200)
#grid.draw(p)
#dev.off()

# Times New Roman version
#png(file="./Output/cort_boxplotsTimes.png", width = 5.5, height = 5.5, units = "in", res = 900)
#grid.draw(p)
#dev.off()
```
<br>
**Figure 2**. Total plasma corticosterone measured from 18 starlings during a pre-experimental standard handling stress series (baseline) and three experimental treatments.  All samples were collected within 3 minutes of initial human contact.  See text for a description of the pre-experiment stress series and experimental treatments.

<hr size = "5" width="100%">

## Equivalence tests
We formally evaluate the equivalence of the stress response to a raptor attack to the handling stress response in the pre-experiment stress series.  We do likewise for the stress response of the control treatment to the pre-experiment baseline stress response.  Tests of equivalence require an *a priori* specification of how much measurements can differ and still be considered equivalent - we specify it as the standard deviation of the relevant pre-experiment stress series measurements.  Thus, for the comparison of experimental control vs. capture-and-restraint baseline CORT, differences less than `r baseSD` ng/mL are considered biologically equivalent.  For the comparison of experimental   raptor attack vs. capture-and-restraint stress CORT, differences less than `r stressSD` ng/mL are considered biologically equivalent.  

```{r compare_stress, echo=FALSE}
base_dat <- ddply(subset(dat, trt == 1), .(id), summarize,
                  experimental = mean(cort),
                  baseline = mean(cort0),
                  base_diff = experimental - baseline,
                  n = length(unique(cort)))
stress_dat <- ddply(subset(dat, trt == 3), .(id), summarize,
                    experimental = mean(cort),
                    baseline = mean(stress0),
                    stress_diff = experimental - baseline,
                    n = length(unique(cort)))

base_tost <- with(base_dat, tost(base_diff, epsilon = baseSD))
stress_tost <- with(stress_dat, tost(stress_diff, epsilon = stressSD))

# Paired t-test of equivalence for fun
base_ptte <- with(base_dat, ptte.stat(mean(base_diff), sd(base_diff), n = 18, Epsilon=0.25))
stress_ptte <- with(stress_dat, ptte.stat(mean(stress_diff), sd(stress_diff), n = 18, Epsilon=0.25))
```

Two one-sided tests for equivalence (TOST; Schuirmann 1981,  Westlake 1981) indicate that in both cases the experimental and capture-and-restraint measurements are equivalent as we have defined it.  That is, the null hypothesis that the measurements were dissimilar was rejected in both cases (experimental control vs. capture-and-restraint baseline CORT: *p* = `r round(base_tost$p.value, 3)`; experimental raptor attack vs. capture-and-restraint stress CORT: *p* = `r round(stress_tost$p.value, 3)`).  It's worth noting, perhaps, that a similar conclusion is reached using a "strict" paired t-test of equivalence (as defined by Wellek 2003).


